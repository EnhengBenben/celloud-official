<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.celloud.backstage.mapper.TaskMapper">
	<resultMap id="BaseResultMap" type="com.celloud.backstage.model.Task">
		<id column="task_id" property="taskId" jdbcType="INTEGER" />
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="app_id" property="appId" jdbcType="INTEGER" />
		<result column="data_key" property="dataKey" jdbcType="VARCHAR" />
		<result column="command" property="command" jdbcType="VARCHAR" />
		<result column="period" property="period" jdbcType="INTEGER" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
		<result column="start_date" property="startDate" jdbcType="TIMESTAMP" />
		<result column="end_date" property="endDate" jdbcType="TIMESTAMP" />
		<result column="project_id" property="projectId" jdbcType="INTEGER" />
		<result column="delete_date" property="deleteDate" jdbcType="TIMESTAMP" />
		<result column="state" property="state" jdbcType="INTEGER" />
	</resultMap>
	<resultMap id="ResultMapWithBLOBs" type="com.celloud.backstage.model.Task"
		extends="BaseResultMap">
		<result column="params" property="params" jdbcType="LONGVARCHAR" />
	</resultMap>
	<sql id="Base_Column_List">
		task_id, user_id, app_id, data_key, command, period, create_date, start_date,
		end_date,
		project_id, delete_date, state
	</sql>
	<sql id="Blob_Column_List">
		params
	</sql>
	<select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		,
		<include refid="Blob_Column_List" />
		from tb_task
		where task_id = #{taskId,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from tb_task
		where task_id = #{taskId,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.celloud.backstage.model.Task">
		insert into tb_task (task_id, user_id, app_id,
		data_key, command, period,
		create_date, start_date, end_date,
		project_id, delete_date, state,
		params)
		values (#{taskId,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER},
		#{appId,jdbcType=INTEGER},
		#{dataKey,jdbcType=VARCHAR}, #{command,jdbcType=VARCHAR}, #{period,jdbcType=INTEGER},
		#{createDate,jdbcType=TIMESTAMP}, #{startDate,jdbcType=TIMESTAMP},
		#{endDate,jdbcType=TIMESTAMP},
		#{projectId,jdbcType=INTEGER}, #{deleteDate,jdbcType=TIMESTAMP}, #{state,jdbcType=INTEGER},
		#{params,jdbcType=LONGVARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="com.celloud.backstage.model.Task">
		insert into tb_task
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="taskId != null">
				task_id,
			</if>
			<if test="userId != null">
				user_id,
			</if>
			<if test="appId != null">
				app_id,
			</if>
			<if test="dataKey != null">
				data_key,
			</if>
			<if test="command != null">
				command,
			</if>
			<if test="period != null">
				period,
			</if>
			<if test="createDate != null">
				create_date,
			</if>
			<if test="startDate != null">
				start_date,
			</if>
			<if test="endDate != null">
				end_date,
			</if>
			<if test="projectId != null">
				project_id,
			</if>
			<if test="deleteDate != null">
				delete_date,
			</if>
			<if test="state != null">
				state,
			</if>
			<if test="params != null">
				params,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="taskId != null">
				#{taskId,jdbcType=INTEGER},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=INTEGER},
			</if>
			<if test="appId != null">
				#{appId,jdbcType=INTEGER},
			</if>
			<if test="dataKey != null">
				#{dataKey,jdbcType=VARCHAR},
			</if>
			<if test="command != null">
				#{command,jdbcType=VARCHAR},
			</if>
			<if test="period != null">
				#{period,jdbcType=INTEGER},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="startDate != null">
				#{startDate,jdbcType=TIMESTAMP},
			</if>
			<if test="endDate != null">
				#{endDate,jdbcType=TIMESTAMP},
			</if>
			<if test="projectId != null">
				#{projectId,jdbcType=INTEGER},
			</if>
			<if test="deleteDate != null">
				#{deleteDate,jdbcType=TIMESTAMP},
			</if>
			<if test="state != null">
				#{state,jdbcType=INTEGER},
			</if>
			<if test="params != null">
				#{params,jdbcType=LONGVARCHAR},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.celloud.backstage.model.Task">
		update tb_task
		<set>
			<if test="userId != null">
				user_id = #{userId,jdbcType=INTEGER},
			</if>
			<if test="appId != null">
				app_id = #{appId,jdbcType=INTEGER},
			</if>
			<if test="dataKey != null">
				data_key = #{dataKey,jdbcType=VARCHAR},
			</if>
			<if test="command != null">
				command = #{command,jdbcType=VARCHAR},
			</if>
			<if test="period != null">
				period = #{period,jdbcType=INTEGER},
			</if>
			<if test="createDate != null">
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="startDate != null">
				start_date = #{startDate,jdbcType=TIMESTAMP},
			</if>
			<if test="endDate != null">
				end_date = #{endDate,jdbcType=TIMESTAMP},
			</if>
			<if test="projectId != null">
				project_id = #{projectId,jdbcType=INTEGER},
			</if>
			<if test="deleteDate != null">
				delete_date = #{deleteDate,jdbcType=TIMESTAMP},
			</if>
			<if test="state != null">
				state = #{state,jdbcType=INTEGER},
			</if>
			<if test="params != null">
				params = #{params,jdbcType=LONGVARCHAR},
			</if>
		</set>
		where task_id = #{taskId,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKeyWithBLOBs" parameterType="com.celloud.backstage.model.Task">
		update tb_task
		set user_id = #{userId,jdbcType=INTEGER},
		app_id = #{appId,jdbcType=INTEGER},
		data_key = #{dataKey,jdbcType=VARCHAR},
		command = #{command,jdbcType=VARCHAR},
		period = #{period,jdbcType=INTEGER},
		create_date = #{createDate,jdbcType=TIMESTAMP},
		start_date = #{startDate,jdbcType=TIMESTAMP},
		end_date = #{endDate,jdbcType=TIMESTAMP},
		project_id = #{projectId,jdbcType=INTEGER},
		delete_date = #{deleteDate,jdbcType=TIMESTAMP},
		state = #{state,jdbcType=INTEGER},
		params = #{params,jdbcType=LONGVARCHAR}
		where task_id = #{taskId,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.celloud.backstage.model.Task">
		update tb_task
		set user_id = #{userId,jdbcType=INTEGER},
		app_id = #{appId,jdbcType=INTEGER},
		data_key = #{dataKey,jdbcType=VARCHAR},
		command = #{command,jdbcType=VARCHAR},
		period = #{period,jdbcType=INTEGER},
		create_date = #{createDate,jdbcType=TIMESTAMP},
		start_date = #{startDate,jdbcType=TIMESTAMP},
		end_date = #{endDate,jdbcType=TIMESTAMP},
		project_id = #{projectId,jdbcType=INTEGER},
		delete_date = #{deleteDate,jdbcType=TIMESTAMP},
		state = #{state,jdbcType=INTEGER}
		where task_id = #{taskId,jdbcType=INTEGER}
	</update>

	<select id="getRunningTimeByPage" resultType="java.util.HashMap">
		select
		a.app_name, floor(sum(TIMESTAMPDIFF(SECOND, t.start_date, t.end_date)) /
		count(t.task_id)) avgSecond
		from tb_task t, tb_app a
		where t.app_id = a.app_id
		<if test="keyword!=null and keyword!=''">
			and a.app_name like '%${keyword}%'
		</if>
		and t.start_date is not null
		and t.end_date is not null
		group by t.app_id
	</select>

	<select id="getQueuingTime" resultType="java.util.HashMap">
		select 
		sum(TIMESTAMPDIFF(SECOND , create_date ,start_date)) totalSecond,
		floor(sum(TIMESTAMPDIFF(SECOND , create_date ,start_date)) / count(task_id)) avgSecond 
		from tb_task 
		where create_date is not null
		and start_date is not null
	</select>
	
	<select id="getTotalRecordCount" resultType="int">
        select 
	    count(1)
	    from tb_task
	</select>
	
	<select id="getCountByState" parameterType="int" resultType="int">
	    select 
	    count(1) 
	    from tb_task 
	    where state = #{state}
	</select>
	
	<select id="getFailCount" resultType="int">
	    select 
	    count(1) 
	    from tb_task 
	    where start_date is null 
	    or end_date is null
	</select>
  <select id="getLastWeekUserLoginTop" resultType="java.util.HashMap">
    select u.username,count(u.username) log_count from
    (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp, tb_user u, tb_log l
    where u.user_id = l.user_id and l.log_date &gt;= start_date and l.log_date &lt;= end_date and u.user_id not in (${testAccountIds})
    group by u.username 
    order by log_count desc 
    limit 10
  </select>
  <select id="getLastWeekAppRunTop" resultType="java.util.HashMap">
    select a.app_name,count(a.app_name) app_count from
      tb_report r,tb_user u,tb_app a,(select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp 
      where r.create_date&gt;=temp.start_date and
      r.create_date&lt;=temp.end_date and 
      r.user_id=u.user_id and
      r.app_id = a.app_id and 
      r.flag = 0 and u.user_id not in(${testAccountIds})
      group by a.app_name
      order by app_count desc
      limit 10
  </select>
  <select id="getLastWeekDataSizeTop" resultType="java.util.HashMap">
    select u.username,sum(f.size) size_sum,count(f.file_id) file_count
      from tb_file f,tb_user u,(select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
      where f.create_date&gt;=temp.start_date and 
      f.create_date&lt;=temp.end_date and 
      f.user_id = u.user_id  and u.user_id not in(${testAccountIds})
      group by u.user_id
      order by size_sum desc
      limit 10
  </select>
  <select id="getActiveUserCount" resultType="java.lang.Integer">
  	select count(user_id)
  	from tb_user where user_id not in(${testAccountIds}) 
  	and state = 0
  	and create_date &lt; (select date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00") from dual)
  </select>
  <select id="getLastActiveUserCount" resultType="java.lang.Integer">
  	select count(user_id)
  	from tb_user where user_id not in(${testAccountIds}) 
  	and state = 0
  	and create_date &lt; (date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00"))
  </select>
  <select id="getAppCount" resultType="java.lang.Integer">
  	select count(app_id) from tb_app where off_line = 0
  	and create_date &lt; (select date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00") from dual)
  </select>
  <select id="getLastAppCount" resultType="java.lang.Integer">
  	select count(app_id) from tb_app where off_line = 0
  	and create_date &lt; (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00"))
  </select>
  <select id="getFileSizeAndCount" resultType="java.util.HashMap">
  	select sum(f.size) fileSize, count(f.file_id) fileCount
  	from tb_file f, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where f.create_date &gt;= start_date
  	and f.create_date &lt;= end_date
  	and f.user_id not in(${testAccountIds})
  </select>
  <select id="getWeekReportCountByFlag" resultType="java.lang.Integer">
  	select count(report_id)
  	from tb_report r, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where r.create_date &gt;= temp.start_date
  	and r.create_date &lt;= temp.end_date
  	and flag = #{flag}
  </select>
  <select id="getWeekClientLoginCount" resultType="java.lang.Integer">
  	select count(l.user_id)
  	from tb_log l,tb_user u,(select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where l.user_id = u.user_id 
  	and browser ='client'
  	and log_date &gt;= temp.start_date
  	and log_date &lt;= temp.end_date
  	and l.user_id not in(${testAccountIds})
  </select>
  <select id="getUserLoginTop" resultType="java.util.HashMap">
    select u.username,count(u.username) log_count
    from tb_user u, tb_log l
    where u.user_id = l.user_id
    and u.user_id not in (${testAccountIds})
    group by u.username 
    order by log_count desc 
    limit 10
  </select>
  <select id="getAppRunTop" resultType="java.util.HashMap">
    select a.app_name,count(a.app_name) app_count from
      tb_report r,tb_user u,tb_app a
      where r.user_id = u.user_id
      and r.app_id = a.app_id
      and r.flag = 0
      and u.user_id not in(${testAccountIds})
      group by a.app_name
      order by app_count desc
      limit 10
  </select>
  <select id="getDataSizeTop" resultType="java.util.HashMap">
    select u.username,sum(f.size) size_sum,count(f.file_id) file_count
      from tb_file f,tb_user u
      where f.user_id = u.user_id
      and u.user_id not in(${testAccountIds})
      group by u.user_id
      order by size_sum desc
      limit 10
  </select>
  <select id="findLoginCountByDay" resultType="java.util.HashMap">
  	select date_format(l.log_date,'%Y-%m-%d') login_date, count(u.user_id) login_count
  	from tb_log l,tb_user u,(select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where l.user_id = u.user_id
  	and l.log_date &gt;= start_date
  	and l.log_date &lt;= end_date
  	and u.user_id not in(${testAccountIds})
    group by date_format(l.log_date,'%Y-%m-%d')
  </select>
  <select id="findLoginCountByUsername" resultType="java.util.HashMap">
  	select u.username, count(u.user_id) login_count from
    tb_log l, tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where l.user_id = u.user_id
    and log_date &gt;= start_date
    and log_date &lt;= end_date
    and u.user_id not in(${testAccountIds})
    group by u.user_id
    order by login_count desc
  </select>
  <select id="findAppRunCountByDay" resultType="java.util.HashMap">
  	select date_format(r.create_date,'%Y-%m-%d') run_date, count(*) run_count
    from tb_report r,tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where r.create_date &gt;= temp.start_date
    and r.create_date &lt;= temp.end_date
    and r.user_id = u.user_id
    and r.flag = 0
    and u.user_id not in(${testAccountIds})
    group by date_format(r.create_date,'%Y-%m-%d')
  </select>
  <select id="findAppRunCountByUsername" resultType="java.util.HashMap">
  	select concat(u.username,'^',a.app_name) user_app, count(*) run_count
  	from tb_report r, tb_user u, tb_app a, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where r.app_id = a.app_id
  	and r.user_id = u.user_id
  	and r.create_date &gt;= temp.start_date
  	and r.create_date &lt;= temp.end_date
  	and u.user_id not in(${testAccountIds})
  	group by user_app
  	order by username
  </select>
  <select id="findAppRunCount" resultType="java.util.HashMap">
  	select a.app_name,count(r.report_id) run_count
  	from tb_report r, tb_user u, tb_app a, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where r.create_date &gt;= temp.start_date
  	and r.create_date &lt;= temp.end_date
  	and r.user_id=u.user_id
  	and r.app_id = a.app_id
  	and r.flag = 0
  	and u.user_id not in(${testAccountIds})
    group by a.app_name
    order by run_count desc
  </select>
  <select id="findFileSizeByUsername" resultType="java.util.HashMap">
  	select u.username,sum(f.size) file_size
  	from tb_file f, tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where f.create_date &gt;= temp.start_date
  	and f.create_date &lt;= temp.end_date
  	and f.user_id = u.user_id
  	and u.user_id not in(${testAccountIds})
    group by f.user_id
    order by file_size desc
  </select>
  <select id="findFileCountByUsername" resultType="java.util.HashMap">
  	select u.username,count(u.username) file_count
  	from tb_file f, tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where f.user_id = u.user_id
  	and f.create_date &gt;= temp.start_date
  	and f.create_date &lt;= temp.end_date
  	and u.user_id not in(${testAccountIds})
  	group by u.username
  	order by file_count desc
  </select>
  <select id="findFileSizeByDay" resultType="java.util.HashMap">
  	select date_format(f.create_date,'%Y-%m-%d') file_date, sum(f.size) file_size
  	from tb_file f, tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where f.create_date &gt;= temp.start_date
  	and f.create_date &lt;= temp.end_date
  	and f.user_id = u.user_id
    and u.user_id not in(${testAccountIds})
    group by date_format(f.create_date,'%Y-%m-%d')
  </select>
  <select id="findFileCountByClient" resultType="java.util.HashMap">
  	select u.username,count(f.file_id) file_count
  	from tb_file f,tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where f.user_id = u.user_id
  	and f.user_id not in(${testAccountIds})
  	and f.md5 is not null
  	and f.state = 0
  	and f.create_date &gt;= temp.start_date
  	and f.create_date &lt;= temp.end_date
  	group by f.user_id
  	order by file_count desc
  </select>
  <select id="findOsBrowser" resultType="java.util.HashMap">
  	select concat(os,'^',browser) os_browser, count(*) os_browser_count
  	from tb_log l, tb_user u, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
  	where l.user_id = u.user_id
  	and log_date &gt;= temp.start_date
  	and log_date &lt;= temp.end_date
  	and u.user_id not in(${testAccountIds})
  	group by os_browser
  	order by os_browser_count desc
  </select>
  <select id="findCompanyCount" resultType="java.lang.Integer">
  	select count(distinct u.company_id)
  	from tb_user u
  	where u.company_id > 2
  	order by u.company_id
  </select>
  <select id="getLastWeekUserLogin" resultType="java.util.HashMap">
    select count(log_date) log_count,date_format(date_sub(l.log_date,interval WEEKDAY(l.log_date) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(l.log_date,interval WEEKDAY(l.log_date) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date 
    from tb_log l, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where l.log_date &lt; date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00")
	and l.user_id not in(${testAccountIds})
	and log_date &gt;= temp.start_date
  	and log_date &lt;= temp.end_date
    group by start_date 
    order by start_date desc
  </select>
  <select id="getLastWeekActiveUser" resultType="java.util.HashMap">
    select count(distinct l.user_id) active_user,date_format(date_sub(l.log_date,interval WEEKDAY(l.log_date) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(l.log_date,interval WEEKDAY(l.log_date) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date 
    from tb_log l, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
	where l.log_date &lt; date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00")
	and l.user_id not in(${testAccountIds}) 
	and log_date &gt;= temp.start_date
  	and log_date &lt;= temp.end_date
    group by start_date 
    order by start_date desc
  </select>
  <select id="getLastWeekAppRun" resultType="java.util.HashMap">
    select count(a.app_name) run_app, date_format(date_sub(r.create_date,interval WEEKDAY(r.create_date) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(r.create_date,interval WEEKDAY(r.create_date) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date 
    from tb_report r,tb_app a, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where r.app_id = a.app_id
    and r.create_date is not null
    and r.flag = 0
    and r.create_date &lt; date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00")
    and r.user_id not in(${testAccountIds})
    and r.create_date &gt;= temp.start_date
  	and r.create_date &lt;= temp.end_date
    group by start_date 
    order by start_date desc
  </select>
  <select id="getLastWeekAppActive" resultType="java.util.HashMap">
    select count(distinct a.app_name) active_app, date_format(date_sub(r.create_date,interval WEEKDAY(r.create_date) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(r.create_date,interval WEEKDAY(r.create_date) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date 
    from tb_report r,tb_app a, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where r.app_id = a.app_id
    and r.create_date is not null
    and r.flag = 0
    and r.create_date &lt; date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00")
    and r.user_id not in(${testAccountIds})
    and r.create_date &gt;= temp.start_date
  	and r.create_date &lt;= temp.end_date
    group by start_date
    order by start_date desc
  </select>
  <select id="getLastWeekDataSize" resultType="java.util.HashMap">
    select count(f.file_id) file_count, sum(f.size) size_sum,date_format(date_sub(f.create_date,interval WEEKDAY(f.create_date) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(f.create_date,interval WEEKDAY(f.create_date) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date
    from tb_file f, (select date_format(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),"%Y-%m-%d 00:00:00") start_date,date_format(date_add(date_sub(date_sub(now(),interval 7 day),interval WEEKDAY(date_sub(now(),interval 7 day)) day),interval 6 day),"%Y-%m-%d 23:59:59") end_date) temp
    where f.user_id not in(${testAccountIds})
   	and f.create_date &lt; date_format(date_sub(now(),interval WEEKDAY(now()) day),"%Y-%m-%d 00:00:00")
   	and f.create_date &gt;= temp.start_date
  	and f.create_date &lt;= temp.end_date
    group by start_date
    order by start_date desc
  </select>
</mapper>